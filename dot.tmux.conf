#--------------------------------------------------------------------------------------------------#
#-- Name     : tmux.conf
#-- Purpose  : Tmux configuration file
#-- Author   : EM Winterschon
#-- Repo     : https://github.com/em-winterschon/dotfiles
#-- Requires : Tmux
#------------:
#-- Date     : 2020-02-21
#-- Version  : 1.4
#--------------------------------------------------------------------------------------------------#

## Cheatsheet during use, these are dynamic commands - do not uncomment
#--------------------------------------------------------------------------------------------------#
# PREFIX : setw synchronize-panes (send commands to all panes, like csshx)
# PREFIX : resize-pane -D (Resizes the current pane down)
# PREFIX : resize-pane -U (Resizes the current pane upward)
# PREFIX : resize-pane -L (Resizes the current pane left)
# PREFIX : resize-pane -R (Resizes the current pane right)
# PREFIX : resize-pane -D 20 (Resizes the current pane down by 20 cells)
# PREFIX : resize-pane -U 20 (Resizes the current pane upward by 20 cells)
# PREFIX : resize-pane -L 20 (Resizes the current pane left by 20 cells)
# PREFIX : resize-pane -R 20 (Resizes the current pane right by 20 cells)
# PREFIX : resize-pane -t 2 20 (Resizes the pane with the id of 2 down by 20 cells)
# PREFIX : resize-pane -t -L 20 (Resizes the pane with the id of 2 left by 20 cells)
#--------------------------------------------------------------------------------------------------#

# Prefix key remapping (local): change default 'C-b' to 'C-z'
#--------------------------------------------------------------------------------------------------#
unbind C-b
set-option -g prefix C-z
bind-key C-z send-prefix

# Window + Pane numerical indexing: set panes and window index to start at 1
#--------------------------------------------------------------------------------------------------#
set -g base-index 1
set -g pane-base-index 1
#set -g window-base-index 1

# General Settings + Panel Formatting
#--------------------------------------------------------------------------------------------------#
# scrollback size
set -g history-limit 655350

# Redraw the client (if interrupted by wall, etc)
bind R refresh-client

# Hotkey Controls
#--------------------------------------------------------------------------------------------------#
# reload tmux config while in session: 'C-r'
bind-key r source-file ~/.tmux.conf \; display-message "Config reloaded"

# synchronize command toggle to all panes
bind-key s set-window-option synchronize-panes\; display-message "synchronize-panes is now #{?pane_synchronized,on,off}"

# -- pane border opts
# pane_id
# pane_title
# pane_index
# pane_start_command
# pane_current_command
# pane_current_path
# pane_pipe
# pane_tty
# pane_pid
# --

# pane border info bar + status output formatting
setw pane-border-status top
set -g pane-border-format "[ix:#{pane_index}][pid:#{pane_pid}] #{pane_title} #{pane_current_path}"

# Window + Split Commands
#--------------------------------------------------------------------------------------------------#
# unbind original splits
unbind '"'
unbind %

# Vertical splits with v or C-v
unbind v
unbind C-v
bind-key v split-window -h
bind-key C-v split-window -h
bind [ split-window -h

# Horizontal splits with h or C-h
unbind h
unbind C-h
bind-key h split-window -v
bind-key C-h split-window -v
bind ] split-window -v

# Ctrl - t or t new window
unbind t
unbind C-t
bind-key t new-window
bind-key C-t new-window

## DISABLED: pending option to confirm kills
#-------------------------------------------
# Ctrl - w or w to kill panes
#unbind w
#unbind C-w
#bind-key w kill-pane
#bind-key C-w kill-pane

# C + control q to kill session
#unbind q
#unbind C-q
#bind-key q kill-session
#bind-key C-q kill-session
#-------------------------------------------

# C + Pagedown : Next window
unbind Pagedown
bind-key Pagedown next-window

# C + Previous window
unbind Pageup
bind-key Pageup previous-window

# switch panes using Alt-arrow without prefix
bind -n M-Left select-pane -L
bind -n M-Right select-pane -R
bind -n M-Up select-pane -U
bind -n M-Down select-pane -D

# Enable mouse control (clickable windows, panes, resizable panes)
#--------------------------------------------------------------------------------------------------#
set -g mouse on

# Copy from tmux to system clipboard
#--------------------------------------------------------------------------------------------------#
# Note: does not work with Wayland, only with X11
# Requires xclip -> yum install xclip
# bind -T copy-mode-vi y copy-pipe "xclip -selection clipboard -i"

# Visual Activity Monitoring between windows
#--------------------------------------------------------------------------------------------------#
setw -g monitor-activity on
set -g visual-activity off
set -g visual-bell off
set -g visual-silence off
set -g bell-action any
set -g display-time 3600
set -g status on

# Enable F3 to disable/enable inner/outer session bind-key grabbing while using nested tmux sessions
#--------------------------------------------------------------------------------------------------#
# Feel free to NOT use this variables at all (remove, rename)
# this are named colors, just for convenience
color_orange="colour166" # 208, 166
color_purple="colour134" # 135, 134
color_green="colour076" # 070
color_blue="colour39"
color_yellow="colour220"
color_red="colour160"
color_black="colour232"
color_white="white" # 015

# This is a theme CONTRACT, you are required to define variables below
# Change values, but not remove/rename variables itself
color_dark="$color_black"
color_light="$color_white"
color_session_text="$color_blue"
color_status_text="colour245"
color_main="$color_orange"
color_secondary="$color_purple"
color_level_ok="$color_green"
color_level_warn="$color_yellow"
color_level_stress="$color_red"
color_window_off_indicator="colour088"
color_window_off_status_bg="colour238"
color_window_off_status_current_bg="colour254"

bind -T root F3  \
  set prefix None \;\
  set key-table off \;\
  set status-style "fg=$color_status_text,bg=$color_window_off_status_bg" \;\
  set window-status-current-format "#[fg=$color_window_off_status_bg,bg=$color_window_off_status_current_bg]$separator_powerline_right#[default] #I:#W# #[fg=$color_window_off_status_current_bg,bg=$color_window_off_status_bg]$separator_powerline_right#[default]" \;\
  set window-status-current-style "fg=$color_dark,bold,bg=$color_window_off_status_current_bg" \;\
  if -F '#{pane_in_mode}' 'send-keys -X cancel' \;\
  refresh-client -S \;\

bind -T off F3 \
  set -u prefix \;\
  set -u key-table \;\
  set -u status-style \;\
  set -u window-status-current-style \;\
  set -u window-status-current-format \;\
  refresh-client -S

wg_is_keys_off="#[fg=$color_light,bg=$color_window_off_indicator]#([ $(tmux show-option -qv key-table) = 'off' ] && echo 'OFF')#[default]"
set -g status-right "$wg_is_keys_off #{sysstat_cpu} | #{sysstat_mem} | #{sysstat_loadavg} | $wg_user_host"

# Themes + Plugins
#--------------------------------------------------------------------------------------------------#
source-file ${HOME}/.tmux/themes/powerline/double/cyan.tmuxtheme

#####################################
# tpm plugin manager
# https://github.com/tmux-plugins/tpm
#####################################
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-battery'
set -g @plugin 'tmux-plugins/tmux-prefix-highlight'
set -g @plugin 'tmux-plugins/tmux-online-status'
set -g @plugin 'tmux-plugins/tmux-sidebar'
set -g @plugin 'tmux-plugins/tmux-copycat'
set -g @plugin 'tmux-plugins/tmux-open'
set -g @plugin 'tmux-plugins/tmux-logging'
set -g @plugin 'samoshkin/tmux-plugin-sysstat'

# Plugin specific config properties
#----------------------------------

# tmux-sidebar file tree viewer
set -g @sidebar-tree 't'
set -g @sidebar-tree-focus 'T'
set -g @sidebar-tree-command 'tree -C'
set -g @open-S 'https://www.google.com/search?q='


######################################
# tmux-yank - advanced copy mode
# https://github.com/tmux-plugins/tmux-yank
#####################################
## How to use:
## 0. Zoom pane with 'C-z'
## 1. Hold shift key while selecting text with mouse
## 2. Text will be highlighted pink, release mouse
## 3. Press ctrl-shift-c to copy text
## 4. Presh shift + click to release highlight
## 5. UnZoom pane with 'C-z'
## 6. Press ctrl-shift-v to paste text
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @yank_selection_mouse 'clipboard'
set -g @yank_action 'copy-pipe-and-cancel'

# Session is considered to be remote when we ssh into host
if-shell 'test -n "$SSH_CLIENT"' \
    'source-file ~/.tmux/tmux.remote.conf'

# initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
run '~/.tmux/plugins/tpm/tpm'
