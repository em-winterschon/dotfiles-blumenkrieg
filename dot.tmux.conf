#--------------------------------------------------------------------------------------------------#
#-- Name     : tmux.conf
#-- Purpose  : Tmux configuration file
#-- Author   : EM Winterschon
#-- Repo     : https://github.com/em-winterschon/dotfiles
#-- Requires : Tmux
#------------:
#-- Date     : 2020-02-26
#-- Version  : 1.5
#--------------------------------------------------------------------------------------------------#

## Keyboard Shortcut Command List (customized)
#--------------------------------------------------------------------------------------------------#
# Command manual: https://tmuxguide.readthedocs.io/en/latest/tmux/tmux.html#commands
# Shortcuts described via '[key]' = 'PREFIX + key'
#
# PREFIX: ctrl + z
#
# Pane vertical split: [v]
# Pane horizontal split: [h]
# Cycle panes: alt + direction arrow (no prefix)
#
# New window: [t]
# Next window: [PageDown]
# Previous window: [PageUp]
#
# Nested TMUX session prefix on/off: F3
# Reload TMUX config: [r]
# Redraw TMUX display: [R]
#
# Search via string + regex: [/]
# Search for URL string: [ctrl + u]
# Search for ipaddr string: [alt + i]
# Navigating results:
# - cycle next match: [n]
# - cycle prev match: [N]
#
# Start point-in-time logging: [shift + p]
# Screenshot viewable pane text: [alt + p]
# Save complete history: [alt + shift + p]
#
#--------------------------------------------------------------------------------------------------#

# Prefix key remapping (local): change default 'C-b' to 'C-z'
#--------------------------------------------------------------------------------------------------#
unbind C-b
set-option -g prefix C-z
bind-key C-z send-prefix

# General Settings
#--------------------------------------------------------------------------------------------------#
# Window + pane numerical indexing: id values start at 1
set -g base-index 1
set -g pane-base-index 1

# Reload tmux config while in session: [r]
bind-key r source-file ~/.tmux.conf \; display-message "Config reloaded"

# Redraw the client (if interrupted by wall, etc)
bind R refresh-client

# Synchronize command toggle to all panes: [s]
bind-key s set-window-option synchronize-panes\; display-message "synchronize-panes is now #{?pane_synchronized,on,off}"

# scrollback size (2Mb)
set -g history-limit 2097152

# Window + Split Commands
#--------------------------------------------------------------------------------------------------#
# Unbind original splits
unbind '"'
unbind %

# Pane vertical split: [v]
unbind v
bind-key v split-window -h

# Pane horizontal split: [h]
unbind h
bind-key h split-window -v

# New window: [t]
unbind t
bind-key t new-window

# Next window: [PageDown]
unbind Pagedown
bind-key Pagedown next-window

# Previous window: [PageUp]
unbind Pageup
bind-key Pageup previous-window

# Cycle through panes: alt-arrow (no prefix)
bind -n M-Left select-pane -L
bind -n M-Right select-pane -R
bind -n M-Up select-pane -U
bind -n M-Down select-pane -D

# Enable mouse control (clickable windows, panes, resizable panes)
#--------------------------------------------------------------------------------------------------#
set -g mouse on

# Visual Activity Monitoring between windows
#--------------------------------------------------------------------------------------------------#
setw -g monitor-activity on
set -g visual-activity off
set -g visual-bell off
set -g visual-silence off
set -g bell-action any
set -g display-time 3600
set -g status on

# Enable F3 to disable/enable inner/outer session bind-key grabbing while using nested tmux sessions
#--------------------------------------------------------------------------------------------------#
# Named color codes for status alteration
color_orange="colour166" # 208, 166
color_purple="colour134" # 135, 134
color_green="colour076" # 070
color_blue="colour39"
color_yellow="colour220"
color_red="colour160"
color_black="colour232"
color_white="white" # 015

# Color symlinks for status alteration
color_dark="$color_black"
color_light="$color_white"
color_session_text="$color_blue"
color_status_text="colour245"
color_main="$color_orange"
color_secondary="$color_purple"
color_level_ok="$color_green"
color_level_warn="$color_yellow"
color_level_stress="$color_red"
color_window_off_indicator="colour088"
color_window_off_status_bg="colour238"
color_window_off_status_current_bg="colour254"

# Toggle nested/remote prefix ON
bind -T root F3  \
  set prefix None \;\
  set key-table off \;\
  set status-style "fg=$color_status_text,bg=$color_window_off_status_bg" \;\
  set window-status-current-format "#[fg=$color_window_off_status_bg,bg=$color_window_off_status_current_bg]$separator_powerline_right#[default] #I:#W# #[fg=$color_window_off_status_current_bg,bg=$color_window_off_status_bg]$separator_powerline_right#[default]" \;\
  set window-status-current-style "fg=$color_dark,bold,bg=$color_window_off_status_current_bg" \;\
  if -F '#{pane_in_mode}' 'send-keys -X cancel' \;\
  refresh-client -S \;\

# Toggle nested/remote prefix OFF
bind -T off F3 \
  set -u prefix \;\
  set -u key-table \;\
  set -u status-style \;\
  set -u window-status-current-style \;\
  set -u window-status-current-format \;\
  refresh-client -S

wg_is_keys_off="#[fg=$color_light,bg=$color_window_off_indicator]#([ $(tmux show-option -qv key-table) = 'off' ] && echo 'OFF')#[default]"
set -g status-right "$wg_is_keys_off #{sysstat_cpu} | #{sysstat_mem} | #{sysstat_loadavg} | $wg_user_host"

# Themes + Plugins
#--------------------------------------------------------------------------------------------------#
source-file ${HOME}/.tmux/themes/powerline/double/cyan.tmuxtheme

#----------------------------------------------------#
# TPM plugin manager
# - https://github.com/tmux-plugins/tpm
#
# Install new plugins: [I]
#
set -g @plugin 'tmux-plugins/tpm'

# Pane History Search
#----------------------------------------------------#
# - https://github.com/tmux-plugins/tmux-copycat
#
# Search via string + regex: [/]
# Search for URL string: [ctrl + u]
# Search for ipaddr string: [alt + i]
#
# Navigating results:
# - cycle next match: [n]
# - cycle prev match: [N]
#
set -g @plugin 'tmux-plugins/tmux-copycat'

## Session Pane Logging
#----------------------------------------------------#
# - https://github.com/bedge/tmux-logging
#
# Start point-in-time logging: [shift + p]
# Screenshot viewable pane text: [alt + p]
# Save complete history: [alt + shift + p]
#
set -g @plugin 'tmux-plugins/tmux-logging'

## System Status Metrics
#----------------------------------------------------#
# - https://github.com/samoshkin/tmux-plugin-sysstat
#
set -g @plugin 'samoshkin/tmux-plugin-sysstat'

## Sidebar File Tree Viewer
#----------------------------------------------------#
#set -g @sidebar-tree 't'
#set -g @sidebar-tree-focus 'T'
#set -g @sidebar-tree-command 'tree -C'
#set -g @open-S 'https://www.google.com/search?q='

## Advanced Copy Mode (Yank)
#----------------------------------------------------#
# - https://github.com/tmux-plugins/tmux-yank
#
# 0) Zoom pane via: [z]
# 1) Hold shift key while selecting text with mouse
# 2) Text will be highlighted, release mouse
# 3) Press ctrl-shift-c to copy text (no prefix)
# 4) Presh shift + click to release highlight
# 5) UnZoom pane via: [z]
# 6) Press ctrl-shift-v to paste text (no prefix)
#
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @yank_selection_mouse 'clipboard'
set -g @yank_action 'copy-pipe-and-cancel'

# Pane border info bar + status output formatting
#----------------------------------------------------#
# conditionally set status at top if >1 panes exist
#
set-hook -g window-layout-changed 'set-window -F pane-border-status "#{?#{==:#{window_panes},1},off,top}"'
set -g pane-border-format "[ix:#{pane_index}][pid:#{pane_pid}] #{pane_title} #{pane_current_path}"

# -- pane border opts
# pane_id
# pane_title
# pane_index
# pane_start_command
# pane_current_command
# pane_current_path
# pane_pipe
# pane_tty
# pane_pid

#----------------------------------------------------#
# Remote Host Configuration Parameters
# (dynamically loaded for SSH sessions)
#----------------------------------------------------#
if-shell 'test -n "$SSH_CLIENT"' \
	 'source-file ~/.tmux/tmux.remote.conf'

#----------------------------------------------------#
# Rename Pane HotKey
#----------------------------------------------------#
#set -g default-command '                      \
#function renamePane () {                      \
#  read -p "Enter Pane Name: " pane_name;      \
#  printf "\033]2;%s\033\\r:r" "${pane_name}"; \
#};                                            \
#export -f renamePane;                         \
#bash -i'
#bind-key -T prefix N send-keys "renamePane" C-m

#----------------------------------------------------#
# Initialize TMUX plugin manager
# (keep this line at the very bottom of tmux.conf)
#----------------------------------------------------#
run '~/.tmux/plugins/tpm/tpm'
